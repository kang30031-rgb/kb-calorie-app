<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaloriePal - ‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .main-app {
            display: none;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* === CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Autocomplete === */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover, .suggestion-item.selected {
            background-color: #f8f9ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #333;
        }

        .suggestion-details {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        /* === CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Barcode Scanner === */
        .barcode-container {
            position: relative;
            margin-bottom: 15px;
        }

        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .scanner-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        #barcode-scanner {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin: 15px 0;
        }

        /* === Firebase Status & Offline Notice === */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .firebase-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .firebase-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .firebase-status.syncing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .sync-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .scanner-status {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .scanner-error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.3);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .stat-label {
	    font-size: 12px;
	    opacity: 0.9;
	    text-transform: uppercase;
	    letter-spacing: 0.5px;
	}

	.stat-progress {
 	   margin-top: 8px;
	}

	.stat-progress .progress-bar {
	    margin: 0;
	}

	.stat-progress small {
	    display: block;
	    text-align: center;
	    margin-top: 3px;
	}

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e9ecef 100%);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .food-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .food-info {
            flex: 1;
        }

        .food-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .food-details {
            font-size: 14px;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 4px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.7);
        }

        .tab.active {
            background: rgba(255,255,255,0.95);
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .meal-section {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin-bottom: 25px;
            position: relative;
        }

        .meal-section::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .meal-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* === Chart Container Styles === */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .weight-input-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .weight-input-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .weight-input-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 5px;
        }

        .storage-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #856404;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        /* Progress Ring */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 20px auto;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: transparent;
            stroke: #e9ecef;
            stroke-width: 8;
        }

        .progress-ring-progress {
            fill: transparent;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 377;
            stroke-dashoffset: 377;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
    
            .grid {
                grid-template-columns: 1fr;
            }
    
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                font-size: 14px;
                padding: 10px 8px;
            }

            .chart-wrapper {
                height: 250px;
            }

            .weight-input-row {
                flex-direction: column;
                gap: 10px;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            /* Mobile adjustments for nutrition form */
            .nutrition-form-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
        }

        /* Nutrition form styling */
        .nutrition-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .nutrition-section {
            border-top: 1px solid #e1e5e9;
            margin: 20px 0;
            padding-top: 20px;
        }

        .nutrition-section h4 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nutrition-note {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            border-left: 3px solid #667eea;
        }

        /* Animation Classes */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in-up {
            animation: slideInUp 0.6s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
    </style>
</head>
<body>
    <!-- Firebase Status -->
    <div id="firebaseStatus" class="firebase-status disconnected">
        <div class="sync-spinner"></div>
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...
    </div>

    <!-- ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div id="storageWarning" class="storage-info" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; max-width: 600px; display: none;">
        ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
        <button onclick="hideStorageWarning()" style="float: right; background: none; border: none; color: #856404; font-weight: bold; cursor: pointer;">√ó</button>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-content">
            <h3 style="margin-bottom: 15px;">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <div id="barcode-scanner"></div>
            <div id="scanner-status" class="scanner-status" style="display: none;">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á...
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-danger" onclick="closeBarcodeScanner()">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card slide-in-up">
            <h2 id="authTitle" style="text-align: center; margin-bottom: 30px; color: #667eea;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div id="offlineNotice" class="offline-notice" style="display: none;">
                üì± ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="loginEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                </div>
                <div class="form-group">
                    <label for="loginPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="loginPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                </div>
                <div id="loginError" class="error" style="display: none;"></div>
                <button class="btn" id="loginBtn" style="width: 100%; margin-bottom: 15px;" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p style="text-align: center;">
                    <a href="#" onclick="showForgotPassword()" style="color: #667eea; font-size: 14px;">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
                </p>
                <p style="text-align: center;">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" onclick="showRegister()" style="color: #667eea;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
                </p>
            </div>

            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="regName">‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="text" id="regName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠">
                </div>
                <div class="form-group">
                    <label for="regEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="regEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                </div>
                <div class="form-group">
                    <label for="regPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="regPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                </div>
                
                <!-- Security Questions Section -->
                <h4 style="margin: 20px 0 15px 0; color: #667eea; font-size: 16px;">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)</h4>

                <div class="form-group">
                    <label for="securityQ1">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ß‡∏±‡∏¢‡πÄ‡∏î‡πá‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    <input type="text" id="securityQ1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                </div>

                <div class="form-group">
                    <label for="securityQ2">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 2: ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    <input type="text" id="securityQ2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                </div>

                <div class="form-group">
                    <label for="securityQ3">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 3: ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    <input type="text" id="securityQ3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                </div>
                
                <div id="registerError" class="error" style="display: none;"></div>
                <button class="btn" id="registerBtn" style="width: 100%; margin-bottom: 15px;" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                <p style="text-align: center;">
                    ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <a href="#" onclick="showLogin()" style="color: #667eea;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                </p>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="hidden">
                <div class="form-group">
                    <label for="forgotEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="forgotEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                </div>
                <div id="forgotPasswordError" class="error" style="display: none;"></div>
                <div id="forgotPasswordSuccess" class="success" style="display: none;"></div>
                <button class="btn" id="forgotPasswordBtn" style="width: 100%; margin-bottom: 15px;" onclick="verifySecurityQuestions()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
                <p style="text-align: center;">
                    <a href="#" onclick="showLogin()" style="color: #667eea;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                </p>
            </div>

            <!-- Security Questions Verification Form -->
            <div id="securityQuestionsForm" class="hidden">
                <p style="text-align: center; margin-bottom: 20px; color: #666; font-size: 14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</p>
                <div id="securityQuestion1" class="form-group">
                    <label id="question1Label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà 1</label>
                    <input type="text" id="answer1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                </div>
                <div id="securityQuestion2" class="form-group">
                    <label id="question2Label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà 2</label>
                    <input type="text" id="answer2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                </div>
                <div id="securityQuestion3" class="form-group">
                    <label id="question3Label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà 3</label>
                    <input type="text" id="answer3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                </div>
                <div class="form-group">
                    <label for="newPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="newPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="confirmPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                </div>
                <div id="securityQuestionsError" class="error" style="display: none;"></div>
                <div id="securityQuestionsSuccess" class="success" style="display: none;"></div>
                <button class="btn" id="resetPasswordBtn" style="width: 100%; margin-bottom: 15px;" onclick="resetPassword()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                <p style="text-align: center;">
                    <a href="#" onclick="showLogin()" style="color: #667eea; font-size: 14px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
                </p>
            </div>
        </div>
    </div>

    <!-- ‡πÅ‡∏≠‡∏õ‡∏´‡∏•‡∏±‡∏Å -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- Header -->
            <div class="header fade-in">
                <div>
                    <h1 style="color: #667eea;">CaloriePal</h1>
                    <p id="welcomeText">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
                </div>
                <div>
                    <button class="btn btn-secondary btn-small" onclick="showProfile()">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                    <button class="btn btn-danger btn-small" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>

            <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
            <div class="card fade-in">
                <h3 style="margin-bottom: 20px;">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
	<div class="stats-grid">
	    <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="caloriesConsumed">0</div>
	        <div class="stat-label">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô</div>
	    </div>
	    <div class="stat-card" onclick="showTab('analytics')">
 	       <div class="stat-number" id="caloriesRemaining">0</div>
	        <div class="stat-label">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
	    </div>
	    <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="proteinConsumed">0g</div>
 	       <div class="stat-label">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</div>
 	       <div class="stat-progress">
	            <div class="progress-bar" style="height: 6px; margin-top: 5px;">
 	               <div class="progress-fill" id="proteinProgress" style="width: 0%; background: #ff6b35;"></div>
	            </div>
	            <small id="proteinTarget" style="font-size: 10px; opacity: 0.8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0g</small>
	        </div>
 	   </div>
 	   <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="sodiumConsumed">0mg</div>
	        <div class="stat-label">‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°</div>
	        <div class="stat-progress">
	            <div class="progress-bar" style="height: 6px; margin-top: 5px;">
	                <div class="progress-fill" id="sodiumProgress" style="width: 0%; background: #ffc107;"></div>
	            </div>
	            <small id="sodiumTarget" style="font-size: 10px; opacity: 0.8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0mg</small>
	        </div>
	    </div>
	    <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="carbsConsumed">0g</div>
	        <div class="stat-label">‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï</div>
	        <div class="stat-progress">
	            <div class="progress-bar" style="height: 6px; margin-top: 5px;">
	                <div class="progress-fill" id="carbsProgress" style="width: 0%; background: #28a745;"></div>
 	           </div>
	            <small id="carbsTarget" style="font-size: 10px; opacity: 0.8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0g</small>
	        </div>
	    </div>
	    <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="fatConsumed">0g</div>
	        <div class="stat-label">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</div>
	        <div class="stat-progress">
 	           <div class="progress-bar" style="height: 6px; margin-top: 5px;">
	                <div class="progress-fill" id="fatProgress" style="width: 0%; background: #6f42c1;"></div>
 	           </div>
	            <small id="fatTarget" style="font-size: 10px; opacity: 0.8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0g</small>
	        </div>
	    </div>
	    <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="fiberConsumed">0g</div>
	        <div class="stat-label">‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
	        <div class="stat-progress">
	            <div class="progress-bar" style="height: 6px; margin-top: 5px;">
	                <div class="progress-fill" id="fiberProgress" style="width: 0%; background: #17a2b8;"></div>
	            </div>
	            <small id="fiberTarget" style="font-size: 10px; opacity: 0.8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0g</small>
	        </div>
	    </div>
	    <div class="stat-card" onclick="showTab('analytics')">
	        <div class="stat-number" id="sugarConsumed">0g</div>
	        <div class="stat-label">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</div>
	        <div class="stat-progress">
	            <div class="progress-bar" style="height: 6px; margin-top: 5px;">
	                <div class="progress-fill" id="sugarProgress" style="width: 0%; background: #dc3545;"></div>
	            </div>
	            <small id="sugarTarget" style="font-size: 10px; opacity: 0.8;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0g</small>
	        </div>
	    </div>
	</div>
                <!-- Progress Ring -->
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#28a745;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#20c997;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle class="progress-ring-circle" cx="60" cy="60" r="50"></circle>
                        <circle class="progress-ring-progress" id="progressRing" cx="60" cy="60" r="50"></circle>
                    </svg>
                    <div class="progress-text" id="progressText">0%</div>
                </div>

                <div style="margin-top: 20px;">
                    <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="calorieProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('food')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                <button class="tab" onclick="showTab('analytics')">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
                <button class="tab" onclick="showTab('profile')">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                <button class="tab" onclick="showTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>

            <!-- Tab: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
            <div id="foodTab" class="tab-content active">
                <div class="grid">
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                        <div class="form-group">
                            <label for="mealType">‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                            <select id="mealType">
                                <option value="breakfast">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</option>
                                <option value="lunch">‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</option>
                                <option value="dinner">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô</option>
                                <option value="snack">‡∏Ç‡∏ô‡∏°‡∏ß‡πà‡∏≤‡∏á</option>
                            </select>
                        </div>
                        
                        <!-- Smart Search with Autocomplete -->
                        <div class="form-group">
                            <label for="foodName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                            <div class="autocomplete-container">
                                <input type="text" id="foodName" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." autocomplete="off">
                                <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
                            </div>
                        </div>

                        <!-- Barcode Scanner -->
                        <div class="barcode-container">
                            <button type="button" class="btn btn-secondary btn-icon" onclick="openBarcodeScanner()">
                                üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="foodAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" id="foodAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="1" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="foodUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <select id="foodUnit">
                                <option value="‡∏à‡∏≤‡∏ô">‡∏à‡∏≤‡∏ô</option>
                                <option value="‡∏ü‡∏≠‡∏á">‡∏ü‡∏≠‡∏á</option>
                                <option value="‡∏ï‡∏±‡∏ß">‡∏ï‡∏±‡∏ß</option>
                                <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                                <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                                <option value="‡∏ä‡πâ‡∏≠‡∏ô">‡∏ä‡πâ‡∏≠‡∏ô</option>
                                <option value="‡πÅ‡∏Å‡πâ‡∏ß">‡πÅ‡∏Å‡πâ‡∏ß</option>
                                <option value="‡∏ä‡∏≤‡∏°">‡∏ä‡∏≤‡∏°</option>
                                <option value="‡πÑ‡∏°‡πâ">‡πÑ‡∏°‡πâ</option>
                                <option value="‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á">‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á</option>
                                <option value="‡∏Å‡∏•‡πà‡∏≠‡∏á">‡∏Å‡∏•‡πà‡∏≠‡∏á</option>
                                <option value="‡∏ñ‡πâ‡∏ß‡∏¢">‡∏ñ‡πâ‡∏ß‡∏¢</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="manualCalories">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (‡∏´‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏ö)</label>
                            <input type="number" id="manualCalories" placeholder="‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡πÉ‡∏´‡πâ" step="0.1">
                        </div>

                        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                        <div class="nutrition-section">
                            <h4>ü•ó ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏´‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏ö)</h4>
    
                            <div class="nutrition-form-grid">
                                <div class="form-group">
                                    <label for="manualProtein">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (g)</label>
                                    <input type="number" id="manualProtein" placeholder="‡∏Å‡∏£‡∏±‡∏°" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="manualCarbs">‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï (g)</label>
                                    <input type="number" id="manualCarbs" placeholder="‡∏Å‡∏£‡∏±‡∏°" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="manualFat">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (g)</label>
                                    <input type="number" id="manualFat" placeholder="‡∏Å‡∏£‡∏±‡∏°" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="manualFiber">‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (g)</label>
                                    <input type="number" id="manualFiber" placeholder="‡∏Å‡∏£‡∏±‡∏°" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="manualSugar">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (g)</label>
                                    <input type="number" id="manualSugar" placeholder="‡∏Å‡∏£‡∏±‡∏°" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="manualSodium">‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏° (mg)</label>
                                    <input type="number" id="manualSodium" placeholder="‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏°" step="1" min="0">
                                </div>
                            </div>
    
                            <div class="nutrition-note">
                                <strong>üí° ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </div>
                        </div>

                        <button class="btn" onclick="addFood()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        
                        <div class="meal-section">
                            <div class="meal-title">üåÖ ‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</div>
                            <div id="breakfastList"></div>
                        </div>

                        <div class="meal-section">
                            <div class="meal-title">‚òÄÔ∏è ‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</div>
                            <div id="lunchList"></div>
                        </div>

                        <div class="meal-section">
                            <div class="meal-title">üåô ‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô</div>
                            <div id="dinnerList"></div>
                        </div>

                        <div class="meal-section">
                            <div class="meal-title">üçø ‡∏Ç‡∏ô‡∏°‡∏ß‡πà‡∏≤‡∏á</div>
                            <div id="snackList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Analytics/Statistics -->
            <div id="analyticsTab" class="tab-content">
                <!-- Weight Tracking Section -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">üìà ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</h3>
                    <div class="weight-input-section">
                        <div class="weight-input-row">
                            <div class="form-group">
                                <label for="weightDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="weightDate">
                            </div>
                            <div class="form-group">
                                <label for="currentWeight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                                <input type="number" id="currentWeight" step="0.1" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                            </div>
                            <button class="btn btn-success" onclick="addWeightEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
                        <div class="chart-wrapper">
                            <canvas id="weightChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Calorie Analytics -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</h3>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="week" onclick="changeCaloriePeriod('week')">7 ‡∏ß‡∏±‡∏ô</button>
                        <button class="chart-btn" data-period="month" onclick="changeCaloriePeriod('month')">30 ‡∏ß‡∏±‡∏ô</button>
                        <button class="chart-btn" data-period="3months" onclick="changeCaloriePeriod('3months')">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
                        <div class="chart-wrapper">
                            <canvas id="calorieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Progress Tracking -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <div class="grid">
                        <div class="chart-container">
                            <div class="chart-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
                            <div class="chart-wrapper">
                                <canvas id="progressChart"></canvas>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="currentWeightStat">0</div>
                                    <div class="stat-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.)</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="targetWeightStat">0</div>
                                    <div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Å‡∏Å.)</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="weightDiffStat">0</div>
                                    <div class="stat-label">‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏Å.)</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="avgCaloriesStat">0</div>
                                    <div class="stat-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà/‡∏ß‡∏±‡∏ô</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nutrition Breakdown -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">ü•ó ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                    <div class="chart-container">
                        <div class="chart-title">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
                        <div class="chart-wrapper">
                            <canvas id="nutritionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
            <div id="profileTab" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <div class="grid">
                        <div>
                            <div class="form-group">
                                <label for="age">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                                <input type="number" id="age" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏">
                            </div>
                            <div class="form-group">
                                <label for="gender">‡πÄ‡∏û‡∏®</label>
                                <select id="gender">
                                    <option value="male">‡∏ä‡∏≤‡∏¢</option>
                                    <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="height">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                                <input type="number" id="height" placeholder="‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á">
                            </div>
                            <div class="form-group">
                                <label for="weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.)</label>
                                <input type="number" id="weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" step="0.1">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="activity">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</label>
                                <select id="activity">
                                    <option value="1.2">‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ç‡∏¢‡∏±‡∏ö</option>
                                    <option value="1.375">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏ö‡∏≤‡πÜ 1-3 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="1.55">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á 3-5 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="1.725">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å 6-7 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="1.9">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å/‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏á</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="goal">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                                <select id="goal">
                                    <option value="-0.5">‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 0.5 ‡∏Å‡∏Å./‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="-0.25">‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 0.25 ‡∏Å‡∏Å./‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="0">‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</option>
                                    <option value="0.25">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 0.25 ‡∏Å‡∏Å./‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="0.5">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 0.5 ‡∏Å‡∏Å./‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="targetWeight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Å‡∏Å.)</label>
                                <input type="number" id="targetWeight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="updateProfile()">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    
                    <div id="tdeeResult" style="margin-top: 20px; display: none;">
                        <h4>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î TDEE</h4>
                        <div class="stats-grid" style="margin-top: 15px;">
                            <div class="stat-card">
                                <div class="stat-number" id="bmrValue">0</div>
                                <div class="stat-label">BMR (kcal/‡∏ß‡∏±‡∏ô)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="tdeeValue">0</div>
                                <div class="stat-label">TDEE (kcal/‡∏ß‡∏±‡∏ô)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="targetCalories">0</div>
                                <div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà/‡∏ß‡∏±‡∏ô</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="bmiValue">0</div>
                                <div class="stat-label">BMI</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
            <div id="historyTab" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button class="fab" onclick="quickAddFood()" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô">+</button>
    </div>

    <!-- Include required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Firebase Module Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc,
            onSnapshot,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQw_1I9wnQrrd0h6HwnX_l3f2VZz-Y1bA",
            authDomain: "kbcal2.firebaseapp.com",
            projectId: "kbcal2",
            storageBucket: "kbcal2.firebasestorage.app",
            messagingSenderId: "991657721252",
            appId: "1:991657721252:web:c3d66fc7b9f08914011531",
            measurementId: "G-9XQ3LJN9EG"
        };

        let app, auth, db, currentUser = null, isFirebaseConnected = false;

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isFirebaseConnected = true;
            updateFirebaseStatus('connected');
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            isFirebaseConnected = false;
            updateFirebaseStatus('disconnected');
            showOfflineMode();
        }

        function updateFirebaseStatus(status) {
            const statusEl = document.getElementById('firebaseStatus');
            if (!statusEl) return;
            
            statusEl.className = 'firebase-status ' + status;
            switch(status) {
                case 'connected':
                    statusEl.innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÅ‡∏•‡πâ‡∏ß';
                    break;
                case 'disconnected':
                    statusEl.innerHTML = '‚ùå ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
                    break;
                case 'syncing':
                    statusEl.innerHTML = '<div class="sync-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...';
                    break;
            }
        }

        function showOfflineMode() {
            const offlineEl = document.getElementById('offlineNotice');
            if (offlineEl) offlineEl.style.display = 'block';
        }

        // Firebase Authentication Functions
        async function firebaseLogin(email, password) {
            if (!isFirebaseConnected) {
                // Offline fallback
                const storedData = getFromStorage();
                if (storedData.users && storedData.users[email] && 
                    storedData.users[email].password === password) {
                    currentUser = email;
                    window.currentUser = currentUser;
                    window.userData = storedData.users || {};
                    window.dailyFoodLog = storedData.dailyLog || {};
                    window.weightLog = storedData.weightLog || {};
                    enterAppLocal();
                    return;
                }
                throw new Error('Invalid credentials');
            }
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user.uid;
                window.currentUser = currentUser;
                await loadFromFirebase();
                enterAppLocal();
                await syncToFirestore();
            } catch (error) {
                throw error;
            }
        }

        async function firebaseRegister(email, password, displayName, securityQuestions = null) {
            if (!isFirebaseConnected) {
                // Offline fallback
                const storedData = getFromStorage();
                if (storedData.users && storedData.users[email]) {
                    throw new Error('Email already exists');
                }
                
                if (!window.userData) window.userData = {};
                window.userData[email] = {
                    name: displayName,
                    password: password,
                    profile: getDefaultProfile(),
                    securityQuestions: securityQuestions || {}
                };
                
                currentUser = email;
                window.currentUser = currentUser;
                saveToStorage();
                enterAppLocal();
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                if (displayName) {
                    await updateProfile(userCredential.user, { displayName: displayName });
                }
                
                currentUser = userCredential.user.uid;
                window.currentUser = currentUser;
                
                // Initialize user data
                if (!window.userData) window.userData = {};
                window.userData[currentUser] = {
                    name: displayName,
                    profile: getDefaultProfile(),
                    securityQuestions: securityQuestions || {}
                };
                
                await syncToFirestore();
                enterAppLocal();
            } catch (error) {
                throw error;
            }
        }

        async function firebaseLogout() {
            try {
                if (isFirebaseConnected && auth) {
                    await signOut(auth);
                }
                currentUser = null;
                window.currentUser = null;
                showAuthPage();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Auth state observer
        if (isFirebaseConnected) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user.uid;
                    window.currentUser = currentUser;
                    await loadFromFirebase();
                    enterAppLocal();
                } else {
                    currentUser = null;
                    window.currentUser = null;
                    showAuthPage();
                }
            });
        } else {
            // Fallback for offline mode
            const stored = getFromStorage();
            if (stored.currentUser) {
                currentUser = stored.currentUser;
                window.currentUser = currentUser;
                window.userData = stored.users || {};
                window.dailyFoodLog = stored.dailyLog || {};
                window.weightLog = stored.weightLog || {};
                enterAppLocal();
            } else {
                showAuthPage();
            }
        }

        // Data synchronization with improved error handling
        async function syncToFirestore() {
            if (!isFirebaseConnected || !currentUser) return;
            
            try {
                updateFirebaseStatus('syncing');
                const userDoc = doc(db, 'users', currentUser);
                const syncData = {
                    userData: window.userData || {},
                    dailyFoodLog: window.dailyFoodLog || {},
                    weightLog: window.weightLog || {},
                    lastSync: serverTimestamp()
                };
                
                await setDoc(userDoc, syncData, { merge: true });
                updateFirebaseStatus('connected');
                console.log('Data synced to Firebase');
                
                // Also save to local storage as backup
                saveToStorage();
            } catch (error) {
                console.error('Sync error:', error);
                updateFirebaseStatus('connected');
            }
        }

        async function loadFromFirebase() {
            if (!isFirebaseConnected || !currentUser) return;
            
            try {
                const userDoc = doc(db, 'users', currentUser);
                const docSnap = await getDoc(userDoc);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Merge Firebase data with local data (local takes precedence)
                    const localData = getFromStorage();
                    
                    window.userData = { ...data.userData, ...localData.users } || {};
                    window.dailyFoodLog = { ...data.dailyFoodLog, ...localData.dailyLog } || {};
                    window.weightLog = { ...data.weightLog, ...localData.weightLog } || {};
                    
                    console.log('Data loaded from Firebase and merged with local');
                    
                    // Save merged data back to storage
                    saveToStorage();
                }
            } catch (error) {
                console.error('Load error:', error);
                // Load from local storage as fallback
                const localData = getFromStorage();
                window.userData = localData.users || {};
                window.dailyFoodLog = localData.dailyLog || {};
                window.weightLog = localData.weightLog || {};
            }
        }

        // Make functions global
        window.login = async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!email || !password) {
                showError('loginError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            
            try {
                await firebaseLogin(email, password);
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        };

        window.register = async function() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const securityQ1 = document.getElementById('securityQ1').value.trim();
            const securityQ2 = document.getElementById('securityQ2').value.trim();
            const securityQ3 = document.getElementById('securityQ3').value.trim();
            const registerBtn = document.getElementById('registerBtn');
            
            if (!name || !email || !password || !securityQ1 || !securityQ2 || !securityQ3) {
                showError('registerError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢');
                return;
            }
            
            if (!isValidEmail(email)) {
                showError('registerError', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (password.length < 6) {
                showError('registerError', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...';
            
            try {
                await firebaseRegister(email, password, name, {
                    q1: securityQ1.toLowerCase(),
                    q2: securityQ2.toLowerCase(),
                    q3: securityQ3.toLowerCase()
                });
            } catch (error) {
                console.error('Register error:', error);
                if (error.code === 'auth/email-already-in-use' || error.message === 'Email already exists') {
                    showError('registerError', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    showError('registerError', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
                }
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            }
        };

        window.logout = firebaseLogout;

        // Network event listeners
        window.addEventListener('online', () => {
            if (isFirebaseConnected && currentUser) {
                syncToFirestore().catch(console.error);
            }
            const offlineEl = document.getElementById('offlineNotice');
            if (offlineEl) offlineEl.style.display = 'none';
        });

        window.addEventListener('offline', () => {
            const offlineEl = document.getElementById('offlineNotice');
            if (offlineEl) offlineEl.style.display = 'block';
            updateFirebaseStatus('disconnected');
        });

        // Utility functions
        function getDefaultProfile() {
            return {
                age: 25,
                gender: 'male',
                height: 170,
                weight: 70,
                activity: 1.375,
                goal: 0,
                targetWeight: 70,
                targetCalories: 2000
            };
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function enterAppLocal() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update welcome text with user's actual name
            let userName = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            if (window.userData && window.userData[currentUser]) {
                userName = window.userData[currentUser].name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            }
            
            const welcomeElement = document.getElementById('welcomeText');
            if (welcomeElement) {
                welcomeElement.textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${userName}`;
            }
            
            // Load app data
            if (window.loadProfile) window.loadProfile();
            if (window.updateDailyStats) window.updateDailyStats();
            if (window.loadFoodLog) window.loadFoodLog();
            if (window.updateAllCharts) window.updateAllCharts();
        }
        function showAuthPage() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            window.showLogin();
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(elementId, message) {
            const successElement = document.getElementById(elementId);
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 8000);
            }
        }

        // Improved storage functions with better error handling
        function saveToStorage() {
            const data = {
                users: window.userData || {},
                dailyLog: window.dailyFoodLog || {},
                weightLog: window.weightLog || {},
                currentUser: currentUser,
                lastSave: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('calorieAppData', JSON.stringify(data));
                console.log('Data saved to localStorage');
            } catch (e) {
                console.error('Cannot save to localStorage:', e);
                // Try to save critical data only
                try {
                    const criticalData = {
                        users: window.userData || {},
                        currentUser: currentUser
                    };
                    localStorage.setItem('calorieAppCritical', JSON.stringify(criticalData));
                } catch (criticalError) {
                    console.error('Cannot save even critical data:', criticalError);
                }
            }
        }

        function getFromStorage() {
            try {
                const stored = localStorage.getItem('calorieAppData');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Fallback to critical data
                const critical = localStorage.getItem('calorieAppCritical');
                if (critical) {
                    const criticalData = JSON.parse(critical);
                    return {
                        users: criticalData.users || {},
                        dailyLog: {},
                        weightLog: {},
                        currentUser: criticalData.currentUser
                    };
                }
                
                return {};
            } catch (e) {
                console.error('Cannot load from localStorage:', e);
                return {};
            }
        }

        // Security Questions and Password Reset functionality
        let securityData = {
            email: '',
            questions: {
                q1: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ß‡∏±‡∏¢‡πÄ‡∏î‡πá‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?',
                q2: '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?',
                q3: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?'
            }
        };

        window.verifySecurityQuestions = async function() {
            const emailEl = document.getElementById('forgotEmail');
            if (!emailEl) return;
            
            const email = emailEl.value.trim();
            const sendBtn = document.getElementById('forgotPasswordBtn');
            
            if (!email || !isValidEmail(email)) {
                showError('forgotPasswordError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            // Check if user exists and has security questions
            let userExists = false;
            if (!isFirebaseConnected) {
                const storedData = getFromStorage();
                if (storedData.users && storedData.users[email] && storedData.users[email].securityQuestions) {
                    userExists = true;
                }
            } else {
                userExists = true;
            }
            
            if (!userExists) {
                showError('forgotPasswordError', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢');
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                securityData.email = email;
                
                showSuccess('forgotPasswordSuccess', `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô`);
                
                setTimeout(() => {
                    showSecurityQuestionsForm();
                    loadUserSecurityQuestions(email);
                }, 2000);
                
            } catch (error) {
                showError('forgotPasswordError', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô';
            }
        };

        function loadUserSecurityQuestions(email) {
            const q1Label = document.getElementById('question1Label');
            const q2Label = document.getElementById('question2Label');
            const q3Label = document.getElementById('question3Label');
            
            if (q1Label) q1Label.textContent = securityData.questions.q1;
            if (q2Label) q2Label.textContent = securityData.questions.q2;
            if (q3Label) q3Label.textContent = securityData.questions.q3;
        }

        function clearSecurityData() {
            securityData = {
                email: '',
                questions: {
                    q1: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ß‡∏±‡∏¢‡πÄ‡∏î‡πá‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?',
                    q2: '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?',
                    q3: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?'
                }
            };
        }

        function showSecurityQuestionsForm() {
            document.getElementById('authTitle').textContent = '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢';
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('securityQuestionsForm').classList.remove('hidden');
            clearAuthForms();
        }

        window.resetPassword = async function() {
            const answer1El = document.getElementById('answer1');
            const answer2El = document.getElementById('answer2');
            const answer3El = document.getElementById('answer3');
            const newPasswordEl = document.getElementById('newPassword');
            const confirmPasswordEl = document.getElementById('confirmPassword');
            const resetBtn = document.getElementById('resetPasswordBtn');
            
            if (!answer1El || !answer2El || !answer3El || !newPasswordEl || !confirmPasswordEl) return;
            
            const answer1 = answer1El.value.trim().toLowerCase();
            const answer2 = answer2El.value.trim().toLowerCase();
            const answer3 = answer3El.value.trim().toLowerCase();
            const newPassword = newPasswordEl.value;
            const confirmPassword = confirmPasswordEl.value;
            
            if (!answer1 || !answer2 || !answer3) {
                showError('securityQuestionsError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
                return;
            }
            
            if (!newPassword || newPassword.length < 6) {
                showError('securityQuestionsError', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('securityQuestionsError', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                return;
            }
            
            resetBtn.disabled = true;
            resetBtn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            
            try {
                let isVerified = false;
                
                if (!isFirebaseConnected) {
                    const storedData = getFromStorage();
                    const userSecurityQuestions = storedData.users?.[securityData.email]?.securityQuestions;
                    
                    if (userSecurityQuestions && 
                        userSecurityQuestions.q1 === answer1 &&
                        userSecurityQuestions.q2 === answer2 &&
                        userSecurityQuestions.q3 === answer3) {
                        isVerified = true;
                        
                        storedData.users[securityData.email].password = newPassword;
                        localStorage.setItem('calorieAppData', JSON.stringify(storedData));
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    isVerified = true;
                }
                
                if (!isVerified) {
                    showError('securityQuestionsError', '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                showSuccess('securityQuestionsSuccess', '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                clearSecurityData();
                
                setTimeout(() => {
                    showLogin();
                    alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà');
                }, 2000);
                
            } catch (error) {
                showError('securityQuestionsError', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
            } finally {
                resetBtn.disabled = false;
                resetBtn.innerHTML = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
            }
        };

        function showForgotPassword() {
            document.getElementById('authTitle').textContent = '‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('securityQuestionsForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            clearAuthForms();
        }

        function showLogin() {
            document.getElementById('authTitle').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('securityQuestionsForm').classList.add('hidden');
            clearAuthForms();
            clearSecurityData();
        }

        function showRegister() {
            document.getElementById('authTitle').textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('securityQuestionsForm').classList.add('hidden');
            clearAuthForms();
            clearSecurityData();
        }

        function clearAuthForms() {
            const inputs = [
                'loginEmail', 'loginPassword', 'regName', 'regEmail', 'regPassword',
                'securityQ1', 'securityQ2', 'securityQ3', 'forgotEmail', 
                'answer1', 'answer2', 'answer3', 'newPassword', 'confirmPassword'
            ];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            const errors = [
                'loginError', 'registerError', 'forgotPasswordError', 'securityQuestionsError'
            ];
            errors.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            const successes = ['forgotPasswordSuccess', 'securityQuestionsSuccess'];
            successes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        // Make utility functions global
        window.saveToStorage = saveToStorage;
        window.getFromStorage = getFromStorage;
        window.syncToFirestore = syncToFirestore;
        window.showForgotPassword = showForgotPassword;
        window.showSecurityQuestionsForm = showSecurityQuestionsForm;
        window.verifySecurityQuestions = verifySecurityQuestions;
        window.showLogin = showLogin;
        window.showRegister = showRegister;
    </script>
    
    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let userData = {};
        let dailyFoodLog = {};
        let weightLog = {};
        let selectedSuggestionIndex = -1;
        let charts = {};

        // ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô - ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        const foodDatabase = {
            '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î': { calories: 250, protein: 8, sodium: 800, carbs: 45, fat: 8, fiber: 2, sugar: 3, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°': { calories: 70, protein: 6, sodium: 70, carbs: 1, fat: 5, fiber: 0, sugar: 0, unit: '‡∏ü‡∏≠‡∏á' },
	        '‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏ï‡πâ‡∏°': { calories: 120, protein: 26, sodium: 60, carbs: 0, fat: 2, fiber: 0, sugar: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
	        '‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß': { calories: 90, protein: 6, sodium: 90, carbs: 1, fat: 7, fiber: 0, sugar: 0, unit: '‡∏ü‡∏≠‡∏á' },
 		        '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß': { calories: 180, protein: 8, sodium: 150, carbs: 3, fat: 15, fiber: 0, sugar: 1, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
	        '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö': { calories: 220, protein: 12, sodium: 200, carbs: 4, fat: 18, fiber: 0, sugar: 1, unit: '‡∏ü‡∏≠‡∏á' },
 	 	        '‡πÑ‡∏Ç‡πà‡∏û‡∏∞‡πÇ‡∏•‡πâ': { calories: 150, protein: 8, sodium: 300, carbs: 8, fat: 10, fiber: 0, sugar: 6, unit: '‡∏ü‡∏≠‡∏á' },
	        '‡πÑ‡∏Ç‡πà‡∏•‡∏ß‡∏Å': { calories: 70, protein: 6, sodium: 70, carbs: 1, fat: 5, fiber: 0, sugar: 0, unit: '‡∏ü‡∏≠‡∏á' },
	        '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß': { calories: 300, protein: 15, sodium: 1200, carbs: 50, fat: 8, fiber: 3, sugar: 5, unit: '‡∏ä‡∏≤‡∏°' },
	        '‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢': { calories: 400, protein: 12, sodium: 900, carbs: 60, fat: 15, fiber: 4, sugar: 12, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á': { calories: 200, protein: 35, sodium: 300, carbs: 0, fat: 6, fiber: 0, sugar: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
	        '‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á': { calories: 250, protein: 20, sodium: 400, carbs: 8, fat: 16, fiber: 0, sugar: 6, unit: '‡πÑ‡∏°‡πâ' },
	        '‡∏™‡πâ‡∏°‡∏ï‡∏≥': { calories: 120, protein: 5, sodium: 600, carbs: 20, fat: 3, fiber: 4, sugar: 15, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô‡∏ô‡∏∂‡πà‡∏á': { calories: 180, protein: 20, sodium: 50, carbs: 0, fat: 11, fiber: 0, sugar: 0, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô': { calories: 280, protein: 18, sodium: 800, carbs: 12, fat: 20, fiber: 3, sugar: 8, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á': { calories: 200, protein: 20, sodium: 1000, carbs: 15, fat: 8, fiber: 2, sugar: 10, unit: '‡∏ä‡∏≤‡∏°' },
	        '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡πà‡∏≤': { calories: 130, protein: 3, sodium: 0, carbs: 28, fat: 0, fiber: 0, sugar: 0, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î': { calories: 90, protein: 3, sodium: 15, carbs: 20, fat: 1, fiber: 3, sugar: 6, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
	        '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°': { calories: 90, protein: 1, sodium: 1, carbs: 23, fat: 0, fiber: 3, sugar: 12, unit: '‡∏ï‡∏±‡∏ß' },
	        '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•': { calories: 80, protein: 0, sodium: 2, carbs: 21, fat: 0, fiber: 4, sugar: 16, unit: '‡∏ï‡∏±‡∏ß' },
	        '‡∏™‡πâ‡∏°': { calories: 60, protein: 1, sodium: 0, carbs: 15, fat: 0, fiber: 3, sugar: 12, unit: '‡∏ï‡∏±‡∏ß' },
	        '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á': { calories: 100, protein: 1, sodium: 2, carbs: 25, fat: 0, fiber: 3, sugar: 23, unit: '‡∏ï‡∏±‡∏ß' },
	        '‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤': { calories: 10, protein: 2, sodium: 1500, carbs: 0, fat: 0, fiber: 0, sugar: 0, unit: '‡∏ä‡πâ‡∏≠‡∏ô' },
	        '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•': { calories: 50, protein: 0, sodium: 0, carbs: 13, fat: 0, fiber: 0, sugar: 13, unit: '‡∏ä‡πâ‡∏≠‡∏ô' },
	        '‡∏ô‡∏°': { calories: 60, protein: 3, sodium: 50, carbs: 5, fat: 3, fiber: 0, sugar: 5, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
	        '‡∏ô‡∏°‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á': { calories: 80, protein: 7, sodium: 90, carbs: 4, fat: 4, fiber: 1, sugar: 1, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
	        '‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏≥': { calories: 5, protein: 0, sodium: 5, carbs: 1, fat: 0, fiber: 0, sugar: 0, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
			'‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà': { calories: 15, protein: 0, sodium: 5, carbs: 1, fat: 0, fiber: 0, sugar: 0, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
	        '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß': { calories: 2, protein: 0, sodium: 1, carbs: 0, fat: 0, fiber: 0, sugar: 0, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
	        '‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤': { calories: 0, protein: 0, sodium: 0, carbs: 0, fat: 0, fiber: 0, sugar: 0, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
	        '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏°‡πÑ‡∏Å‡πà': { calories: 200, protein: 15, sodium: 600, carbs: 25, fat: 5, fiber: 1, sugar: 2, unit: '‡∏ä‡∏≤‡∏°' },
	        '‡πÇ‡∏à‡πä‡∏Å': { calories: 150, protein: 8, sodium: 400, carbs: 25, fat: 3, fiber: 1, sugar: 1, unit: '‡∏ä‡∏≤‡∏°' },
	        '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á': { calories: 80, protein: 3, sodium: 150, carbs: 14, fat: 1, fiber: 1, sugar: 2, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
	        '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏Å‡πÑ‡∏Å‡πà': { calories: 350, protein: 20, sodium: 900, carbs: 45, fat: 12, fiber: 2, sugar: 4, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á‡πÑ‡∏ü‡πÅ‡∏î‡∏á': { calories: 80, protein: 3, sodium: 400, carbs: 10, fat: 4, fiber: 3, sugar: 5, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡∏•‡∏≤‡∏ö‡∏´‡∏°‡∏π': { calories: 200, protein: 18, sodium: 700, carbs: 8, fat: 12, fiber: 2, sugar: 3, unit: '‡∏à‡∏≤‡∏ô' },
	        '‡πÅ‡∏Å‡∏á‡∏™‡πâ‡∏°‡∏õ‡∏•‡∏≤': { calories: 150, protein: 15, sodium: 800, carbs: 12, fat: 6, fiber: 2, sugar: 8, unit: '‡∏ä‡∏≤‡∏°' },
	        '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà': { calories: 400, protein: 15, sodium: 1000, carbs: 55, fat: 15, fiber: 3, sugar: 5, unit: '‡∏à‡∏≤‡∏ô' }
};

        // Mock barcode database - ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°
        const barcodeDatabase = {
            '8851234567890': { name: '‡∏°‡∏≤‡∏°‡πà‡∏≤‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á', calories: 320, protein: 8, sodium: 1200, unit: '‡∏ñ‡πâ‡∏ß‡∏¢' },
            '8851234567891': { name: '‡πÄ‡∏ô‡∏™‡πÄ‡∏ó‡πà ‡∏°‡∏¥‡πÇ‡∏•', calories: 180, protein: 4, sodium: 80, unit: '‡πÅ‡∏Å‡πâ‡∏ß' },
            '8851234567892': { name: '‡πÇ‡∏Ñ‡πâ‡∏Å‡πÇ‡∏ã‡∏î‡∏≤', calories: 140, protein: 0, sodium: 40, unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á' },
            '8851234567893': { name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ó', calories: 80, protein: 3, sodium: 150, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
            '8851234567894': { name: '‡∏ô‡∏°‡∏™‡∏î‡∏ï‡∏£‡∏≤‡∏ß‡∏µ', calories: 150, protein: 8, sodium: 100, unit: '‡∏Å‡∏•‡πà‡∏≠‡∏á' },
            '8851234567895': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á', calories: 450, protein: 25, sodium: 800, unit: '‡∏Å‡∏•‡πà‡∏≠‡∏á' },
            '8851234567896': { name: '‡∏ô‡∏°‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß', calories: 120, protein: 3, sodium: 60, unit: '‡∏Å‡∏•‡πà‡∏≠‡∏á' },
            '8851234567897': { name: '‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï', calories: 100, protein: 5, sodium: 70, unit: '‡∏ñ‡πâ‡∏ß‡∏¢' },
            '8857124188136': { name: 'grainey', calories: 80, protein: 1, sodium: 0, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
			'8851234567898': { name: '‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä‡πÑ‡∏Ç‡πà', calories: 280, protein: 12, sodium: 400, unit: '‡∏ä‡∏¥‡πâ‡∏ô' },
            '8851234567899': { name: '‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Å‡πà', calories: 200, protein: 20, sodium: 300, unit: '‡∏à‡∏≤‡∏ô' }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        function init() {
            setupAutocomplete();
            initializeCharts();
            
            // Set today's date for weight input
            const today = new Date().toISOString().split('T')[0];
            const weightDateEl = document.getElementById('weightDate');
            if (weightDateEl) weightDateEl.value = today;
            
            // Auto-save every 30 seconds
            setInterval(() => {
                if (window.currentUser && window.saveToStorage) {
                    window.saveToStorage();
                }
            }, 30000);
        }

        // === CHART INITIALIZATION ===
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };

            // Weight Chart
            const weightCtx = document.getElementById('weightChart');
            if (weightCtx) {
                charts.weight = new Chart(weightCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: chartOptions
                });
            }

            // Calorie Chart
            const calorieCtx = document.getElementById('calorieChart');
            if (calorieCtx) {
                charts.calorie = new Chart(calorieCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ',
                            data: [],
                            backgroundColor: 'rgba(40, 167, 69, 0.6)',
                            borderColor: '#28a745',
                            borderWidth: 2
                        }, {
                            label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢',
                            data: [],
                            type: 'line',
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }]
                    },
                    options: chartOptions
                });
            }

            // Progress Chart
            const progressCtx = document.getElementById('progressChart');
            if (progressCtx) {
                charts.progress = new Chart(progressCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÅ‡∏•‡πâ‡∏ß', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å'],
                        datasets: [{
                            data: [0, 100],
                            backgroundColor: ['#28a745', '#e9ecef'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Nutrition Chart
            const nutritionCtx = document.getElementById('nutritionChart');
            if (nutritionCtx) {
                charts.nutrition = new Chart(nutritionCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï', '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô'],
                        datasets: [{
                            data: [50, 30, 20],
                            backgroundColor: ['#667eea', '#28a745', '#ffc107'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // === SMART SEARCH & AUTOCOMPLETE FUNCTIONALITY ===
        function setupAutocomplete() {
            const foodNameInput = document.getElementById('foodName');
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');

            if (!foodNameInput || !suggestionsDiv) return;

            foodNameInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                if (query.length === 0) {
                    hideSuggestions();
                    return;
                }
                showSuggestions(query);
            });

            foodNameInput.addEventListener('keydown', function(e) {
                const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
                if (suggestions.length === 0) return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                        updateSuggestionSelection(suggestions);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSuggestionSelection(suggestions);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            selectSuggestion(suggestions[selectedSuggestionIndex]);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!foodNameInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    hideSuggestions();
                }
            });
        }

        function showSuggestions(query) {
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');
            const matches = findMatches(query);
            
            if (matches.length === 0) {
                hideSuggestions();
                return;
            }

            suggestionsDiv.innerHTML = matches.map((match, index) => `
                <div class="suggestion-item" data-food-name="${match.name}" onclick="selectSuggestionByClick(this)">
                    <div class="suggestion-name">${highlightMatch(match.name, query)}</div>
                    <div class="suggestion-details">${match.calories} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà, ${match.protein}g ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (${match.unit})</div>
                </div>
            `).join('');

            suggestionsDiv.style.display = 'block';
            selectedSuggestionIndex = -1;
        }

        function findMatches(query) {
            const matches = [];
            
            // Exact matches first
            for (const [name, data] of Object.entries(foodDatabase)) {
                if (name.toLowerCase() === query) {
                    matches.push({ name, ...data, score: 100 });
                }
            }
            
            // Starts with matches
            for (const [name, data] of Object.entries(foodDatabase)) {
                if (name.toLowerCase().startsWith(query) && name.toLowerCase() !== query) {
                    matches.push({ name, ...data, score: 90 });
                }
            }
            
            // Contains matches
            for (const [name, data] of Object.entries(foodDatabase)) {
                if (name.toLowerCase().includes(query) && !name.toLowerCase().startsWith(query)) {
                    matches.push({ name, ...data, score: 70 });
                }
            }
            
            return matches.sort((a, b) => b.score - a.score).slice(0, 5);
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<strong style="background: #fff3cd;">$1</strong>');
        }

        function updateSuggestionSelection(suggestions) {
            suggestions.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }

        function selectSuggestion(suggestionElement) {
            const foodName = suggestionElement.getAttribute('data-food-name');
            document.getElementById('foodName').value = foodName;
            
            // Auto-fill unit if available
            if (foodDatabase[foodName]) {
                const unitEl = document.getElementById('foodUnit');
                if (unitEl) unitEl.value = foodDatabase[foodName].unit;
            }
            
            hideSuggestions();
        }

        function selectSuggestionByClick(element) {
            selectSuggestion(element);
        }

        function hideSuggestions() {
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            selectedSuggestionIndex = -1;
        }

        // === BARCODE SCANNER FUNCTIONALITY ===
        function openBarcodeScanner() {
            const modal = document.getElementById('scannerModal');
            const statusDiv = document.getElementById('scanner-status');
            
            if (!modal || !statusDiv) return;
            
            modal.style.display = 'flex';
            statusDiv.style.display = 'block';
            statusDiv.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
            statusDiv.className = 'scanner-status';
            
            // Check if device supports camera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusDiv.textContent = '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                statusDiv.className = 'scanner-status scanner-error';
                return;
            }

            // Initialize Quagga scanner
            if (typeof Quagga !== 'undefined') {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#barcode-scanner'),
                        constraints: {
                            width: 300,
                            height: 200,
                            facingMode: "environment"
                        }
                    },
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader"
                        ]
                    }
                }, function(err) {
                    if (err) {
                        console.error('Barcode scanner error:', err);
                        statusDiv.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err.message;
                        statusDiv.className = 'scanner-status scanner-error';
                        return;
                    }
                    
                    statusDiv.textContent = '‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß';
                    statusDiv.className = 'scanner-status';
                    Quagga.start();
                });

                // Handle barcode detection
                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    handleBarcodeResult(code);
                    closeBarcodeScanner();
                });
            } else {
                statusDiv.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Barcode Scanner';
                statusDiv.className = 'scanner-status scanner-error';
            }
        }

        function closeBarcodeScanner() {
            if (typeof Quagga !== 'undefined') {
                Quagga.stop();
            }
            const modal = document.getElementById('scannerModal');
            if (modal) modal.style.display = 'none';
        }

        function handleBarcodeResult(barcode) {
            if (barcodeDatabase[barcode]) {
                const product = barcodeDatabase[barcode];
                
                // Auto-fill form with product data
                const foodNameEl = document.getElementById('foodName');
                const foodUnitEl = document.getElementById('foodUnit');
                const manualCaloriesEl = document.getElementById('manualCalories');
                
                if (foodNameEl) foodNameEl.value = product.name;
                if (foodUnitEl) foodUnitEl.value = product.unit;
                if (manualCaloriesEl) manualCaloriesEl.value = product.calories;
                
                // Show success message
                alert(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.name}\n‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà: ${product.calories} kcal`);
            } else {
                // For demo purposes, show the barcode and let user enter manually
                alert(`‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${barcode}\n‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á`);
                const foodNameEl = document.getElementById('foodName');
                if (foodNameEl) foodNameEl.value = `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ${barcode}`;
            }
        }

        // === WEIGHT TRACKING FUNCTIONS ===
        function addWeightEntry() {
            const dateEl = document.getElementById('weightDate');
            const weightEl = document.getElementById('currentWeight');
            
            if (!dateEl || !weightEl) return;
            
            const date = dateEl.value;
            const weight = parseFloat(weightEl.value);

            if (!date || !weight || weight <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            if (!window.weightLog) window.weightLog = {};
            
            // Use user-specific key for weight log
            const userKey = window.currentUser || 'demo';
            if (!window.weightLog[userKey]) {
                window.weightLog[userKey] = {};
            }
            
            window.weightLog[userKey][date] = weight;
            
            // Clear form
            weightEl.value = '';
            
            // Save and update displays
            if (window.saveToStorage) window.saveToStorage();
            if (window.syncToFirestore) window.syncToFirestore();
            
            updateWeightChart();
            updateProgressStats();
            
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        function updateWeightChart() {
            if (!charts.weight || !window.weightLog) return;
            
            const userKey = window.currentUser || 'demo';
            const userWeights = window.weightLog[userKey] || {};
            
            const sortedEntries = Object.entries(userWeights)
                .sort(([a], [b]) => new Date(a) - new Date(b));
            
            const labels = sortedEntries.map(([date]) => {
                const d = new Date(date);
                return d.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
            });
            
            const data = sortedEntries.map(([, weight]) => weight);
            
            charts.weight.data.labels = labels;
            charts.weight.data.datasets[0].data = data;
            charts.weight.update();
        }

        function updateProgressStats() {
            const userKey = window.currentUser || 'demo';
            const profile = window.userData[userKey]?.profile;
            
            if (!profile) return;
            
            const userWeights = window.weightLog[userKey] || {};
            const weightEntries = Object.entries(userWeights);
            let currentWeight = profile.weight;
            
            if (weightEntries.length > 0) {
                const latestEntry = weightEntries.sort(([a], [b]) => new Date(b) - new Date(a))[0];
                currentWeight = latestEntry[1];
            }
            
            const targetWeight = profile.targetWeight || profile.weight;
            const weightDiff = Math.abs(targetWeight - currentWeight);
            
            // Update stat displays
            const currentWeightEl = document.getElementById('currentWeightStat');
            const targetWeightEl = document.getElementById('targetWeightStat');
            const weightDiffEl = document.getElementById('weightDiffStat');
            
            if (currentWeightEl) currentWeightEl.textContent = currentWeight.toFixed(1);
            if (targetWeightEl) targetWeightEl.textContent = targetWeight.toFixed(1);
            if (weightDiffEl) {
                const sign = currentWeight > targetWeight ? '-' : '+';
                weightDiffEl.textContent = sign + weightDiff.toFixed(1);
            }
            
            // Update progress chart
            if (charts.progress) {
                const totalChange = Math.abs(profile.weight - targetWeight);
                const currentProgress = totalChange > 0 ? Math.abs(profile.weight - currentWeight) : 0;
                const progressPercentage = totalChange > 0 ? (currentProgress / totalChange) * 100 : 100;
                
                charts.progress.data.datasets[0].data = [progressPercentage, 100 - progressPercentage];
                charts.progress.update();
            }
        }

        // === CALORIE ANALYTICS FUNCTIONS ===
        function changeCaloriePeriod(period) {
            // Update button states
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) event.target.classList.add('active');
            
            updateCalorieChart(period);
        }

        function updateCalorieChart(period = 'week') {
            if (!charts.calorie || !window.dailyFoodLog) return;
            
            const userKey = window.currentUser || 'demo';
            const profile = window.userData[userKey]?.profile;
            const targetCalories = profile?.targetCalories || 2000;
            
            let days = 7;
            if (period === 'month') days = 30;
            else if (period === '3months') days = 90;
            
            const today = new Date();
            const labels = [];
            const calorieData = [];
            const targetData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                // Format label based on period
                let label;
                if (period === 'week') {
                    label = date.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric' });
                } else {
                    label = date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
                }
                labels.push(label);
                
                // Calculate calories for this date
                let totalCalories = 0;
                const dayLog = window.dailyFoodLog[userKey]?.[dateString];
                if (dayLog) {
                    Object.values(dayLog).forEach(meal => {
                        if (Array.isArray(meal)) {
                            meal.forEach(food => {
                                totalCalories += food.calories || 0;
                            });
                        }
                    });
                }
                
                calorieData.push(totalCalories);
                targetData.push(targetCalories);
            }
            
            charts.calorie.data.labels = labels;
            charts.calorie.data.datasets[0].data = calorieData;
            charts.calorie.data.datasets[1].data = targetData;
            charts.calorie.update();
            
            // Update average calories stat
            const avgCalories = calorieData.length > 0 ? 
                Math.round(calorieData.reduce((a, b) => a + b, 0) / calorieData.length) : 0;
            const avgCaloriesEl = document.getElementById('avgCaloriesStat');
            if (avgCaloriesEl) avgCaloriesEl.textContent = avgCalories;
        }

        function updateNutritionChart() {
            if (!charts.nutrition || !window.dailyFoodLog) return;
            
            const userKey = window.currentUser || 'demo';
            const today = new Date().toISOString().split('T')[0];
            const todayLog = window.dailyFoodLog[userKey]?.[today] || {};
            
            let totalCalories = 0, totalProtein = 0;
            
            Object.values(todayLog).forEach(meal => {
                if (Array.isArray(meal)) {
                    meal.forEach(food => {
                        totalCalories += food.calories || 0;
                        totalProtein += food.protein || 0;
                    });
                }
            });
            
            // Estimate macros (simplified calculation)
            const proteinCalories = totalProtein * 4; // 4 kcal per gram of protein
            const estimatedFat = Math.max((totalCalories * 0.3) / 9, 0); // 30% of calories from fat, 9 kcal per gram
            const estimatedCarbs = Math.max((totalCalories - proteinCalories - (estimatedFat * 9)) / 4, 0);
            
            const macros = [
                Math.round(estimatedCarbs),
                totalProtein,
                Math.round(estimatedFat)
            ];
            
            charts.nutrition.data.datasets[0].data = macros;
            charts.nutrition.update();
        }

        function updateAllCharts() {
            if (window.currentUser) {
                updateWeightChart();
                updateCalorieChart('week');
                updateProgressStats();
                updateNutritionChart();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function addFood() {
            const mealTypeEl = document.getElementById('mealType');
            const foodNameEl = document.getElementById('foodName');
            const amountEl = document.getElementById('foodAmount');
            const unitEl = document.getElementById('foodUnit');
            const manualCaloriesEl = document.getElementById('manualCalories');
            
            if (!mealTypeEl || !foodNameEl || !amountEl || !unitEl) return;

            const mealType = mealTypeEl.value;
            const foodName = foodNameEl.value.trim();
            const amount = parseFloat(amountEl.value) || 1;
            const unit = unitEl.value;
            const manualCalories = manualCaloriesEl ? parseFloat(manualCaloriesEl.value) : null;

            if (!foodName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
                return;
            }

            const userKey = window.currentUser || 'demo';
            const today = new Date().toISOString().split('T')[0];
            
            if (!window.dailyFoodLog) window.dailyFoodLog = {};
            if (!window.dailyFoodLog[userKey]) window.dailyFoodLog[userKey] = {};
            if (!window.dailyFoodLog[userKey][today]) {
                window.dailyFoodLog[userKey][today] = {
                    breakfast: [],
                    lunch: [],
                    dinner: [],
                    snack: []
                };
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            let calories, protein = 0, sodium = 0, carbs = 0, fat = 0, fiber = 0, sugar = 0;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
            const manualProteinEl = document.getElementById('manualProtein');
            const manualCarbsEl = document.getElementById('manualCarbs');
            const manualFatEl = document.getElementById('manualFat');
            const manualFiberEl = document.getElementById('manualFiber');
            const manualSugarEl = document.getElementById('manualSugar');
            const manualSodiumEl = document.getElementById('manualSodium');

            const manualProtein = manualProteinEl ? parseFloat(manualProteinEl.value) : null;
            const manualCarbs = manualCarbsEl ? parseFloat(manualCarbsEl.value) : null;
            const manualFat = manualFatEl ? parseFloat(manualFatEl.value) : null;
            const manualFiber = manualFiberEl ? parseFloat(manualFiberEl.value) : null;
            const manualSugar = manualSugarEl ? parseFloat(manualSugarEl.value) : null;
            const manualSodium = manualSodiumEl ? parseFloat(manualSodiumEl.value) : null;

            if (manualCalories) {
                // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
                calories = manualCalories * amount;
    
                // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
                protein = manualProtein ? manualProtein * amount : (calories * 0.2 / 4); // 20% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà
                carbs = manualCarbs ? manualCarbs * amount : (calories * 0.5 / 4); // 50% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà
                fat = manualFat ? manualFat * amount : (calories * 0.3 / 9); // 30% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà
                fiber = manualFiber ? manualFiber * amount : (carbs * 0.1); // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏£‡πå‡∏ö
                sugar = manualSugar ? manualSugar * amount : (carbs * 0.3); // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 30% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏£‡πå‡∏ö
                sodium = manualSodium ? manualSodium * amount : 300 * amount; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    
            } else if (foodDatabase[foodName]) {
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
                const foodData = foodDatabase[foodName];
                calories = foodData.calories * amount;
    
                protein = manualProtein ? manualProtein * amount : foodData.protein * amount;
                carbs = manualCarbs ? manualCarbs * amount : (foodData.carbs || 0) * amount;
                fat = manualFat ? manualFat * amount : (foodData.fat || 0) * amount;
                fiber = manualFiber ? manualFiber * amount : (foodData.fiber || 0) * amount;
                sugar = manualSugar ? manualSugar * amount : (foodData.sugar || 0) * amount;
                sodium = manualSodium ? manualSodium * amount : foodData.sodium * amount;
    
            } else {
                // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                calories = 150 * amount; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    
                protein = manualProtein ? manualProtein * amount : 5 * amount;
                carbs = manualCarbs ? manualCarbs * amount : 20 * amount;
                fat = manualFat ? manualFat * amount : 5 * amount;
                fiber = manualFiber ? manualFiber * amount : 2 * amount;
                sugar = manualSugar ? manualSugar * amount : 3 * amount;
                sodium = manualSodium ? manualSodium * amount : 300 * amount;
            }

            const foodItem = {
                name: foodName,
                amount: amount,
                unit: unit,
                calories: Math.round(calories),
                protein: Math.round(protein),
                sodium: Math.round(sodium),
                carbs: Math.round(carbs),
                fat: Math.round(fat),
                fiber: Math.round(fiber),
                sugar: Math.round(sugar),
                timestamp: new Date().toISOString()
            };

            window.dailyFoodLog[userKey][today][mealType].push(foodItem);
            
           // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
           foodNameEl.value = '';
           amountEl.value = '1';
           if (manualCaloriesEl) manualCaloriesEl.value = '';

           // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
           if (manualProteinEl) manualProteinEl.value = '';
           if (manualCarbsEl) manualCarbsEl.value = '';
           if (manualFatEl) manualFatEl.value = '';
           if (manualFiberEl) manualFiberEl.value = '';
           if (manualSugarEl) manualSugarEl.value = '';
           if (manualSodiumEl) manualSodiumEl.value = '';

           hideSuggestions();

            // Save and update displays
            if (window.saveToStorage) window.saveToStorage();
            if (window.syncToFirestore) window.syncToFirestore();
            
            loadFoodLog();
            updateDailyStats();
            updateAllCharts();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
        function loadFoodLog() {
            const userKey = window.currentUser || 'demo';
            const today = new Date().toISOString().split('T')[0];
            const todayLog = window.dailyFoodLog[userKey]?.[today] || {
                breakfast: [], lunch: [], dinner: [], snack: []
            };

            const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
            const mealContainers = ['breakfastList', 'lunchList', 'dinnerList', 'snackList'];

            mealTypes.forEach((mealType, index) => {
                const container = document.getElementById(mealContainers[index]);
                if (!container) return;
                
                const foods = todayLog[mealType] || [];
                
                if (foods.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>';
                } else {
                    container.innerHTML = foods.map((food, idx) => `
                        <div class="food-item">
                            <div class="food-info">
                                <div class="food-name">${food.name}</div>
                                <div class="food-details">${food.amount} ${food.unit} - ${Math.round(food.calories)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
                                <div class="food-details" style="font-size: 12px; color: #888; margin-top: 2px;">
                                    ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô: ${Math.round(food.protein || 0)}g | 
                                    ‡∏Ñ‡∏≤‡∏£‡πå‡∏ö: ${Math.round(food.carbs || 0)}g | 
                                    ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô: ${Math.round(food.fat || 0)}g | 
                                    ‡πÉ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ${Math.round(food.fiber || 0)}g
                                    ${food.sodium ? `| ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°: ${Math.round(food.sodium)}mg` : ''}
                                </div>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="removeFood('${mealType}', ${idx})">‡∏•‡∏ö</button>
                        </div>
                    `).join('');
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£
        function removeFood(mealType, index) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            const userKey = window.currentUser || 'demo';
            const today = new Date().toISOString().split('T')[0];
            
            if (window.dailyFoodLog[userKey] && window.dailyFoodLog[userKey][today] && window.dailyFoodLog[userKey][today][mealType]) {
                window.dailyFoodLog[userKey][today][mealType].splice(index, 1);
                
                // Save and update displays
                if (window.saveToStorage) window.saveToStorage();
                if (window.syncToFirestore) window.syncToFirestore();
                
                loadFoodLog();
                updateDailyStats();
                updateAllCharts();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        function updateDailyStats() {
	    const userKey = window.currentUser || 'demo';
	    const today = new Date().toISOString().split('T')[0];
	    const todayLog = window.dailyFoodLog[userKey]?.[today] || {
	        breakfast: [], lunch: [], dinner: [], snack: []
	    };
    
	    let totalCalories = 0, totalProtein = 0, totalSodium = 0;
	    let totalCarbs = 0, totalFat = 0, totalFiber = 0, totalSugar = 0;
    
            Object.values(todayLog).forEach(meal => {
                if (Array.isArray(meal)) {
                    meal.forEach(food => {
                        totalCalories += food.calories || 0;
                        totalProtein += food.protein || 0;
                        totalSodium += food.sodium || 0;
                        totalCarbs += food.carbs || 0;
                        totalFat += food.fat || 0;
                        totalFiber += food.fiber || 0;
                        totalSugar += food.sugar || 0;
                    });
                }
            });

            const profile = window.userData[userKey]?.profile;
            const targetCalories = profile?.targetCalories || 2000;
            const remainingCalories = Math.max(0, targetCalories - totalCalories);
    
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            const weight = profile?.weight || 70;
            const age = profile?.age || 25;
            const gender = profile?.gender || 'male';
    
            // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£)
            const proteinTarget = Math.round(weight * 1.2); // 1.2g ‡∏ï‡πà‡∏≠ kg ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß
            const sodiumTarget = 2300; // mg ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á WHO)
            const carbsTarget = Math.round(targetCalories * 0.5 / 4); // 50% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà
            const fatTarget = Math.round(targetCalories * 0.3 / 9); // 30% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà
            const fiberTarget = age < 50 ? (gender === 'male' ? 38 : 25) : (gender === 'male' ? 30 : 21); // g ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
            const sugarTarget = Math.round(targetCalories * 0.1 / 4); // ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10% ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà

            // Update stat cards
            const elements = {
                caloriesConsumed: Math.round(totalCalories),
                caloriesRemaining: Math.round(remainingCalories),
                proteinConsumed: Math.round(totalProtein) + 'g',
                sodiumConsumed: Math.round(totalSodium) + 'mg',
                carbsConsumed: Math.round(totalCarbs) + 'g',
                fatConsumed: Math.round(totalFat) + 'g',
                fiberConsumed: Math.round(totalFiber) + 'g',
                sugarConsumed: Math.round(totalSugar) + 'g'
            };

            // Update targets
            const targets = {
                proteinTarget: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${proteinTarget}g`,
                sodiumTarget: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${sodiumTarget}mg`,
                carbsTarget: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${carbsTarget}g`,
                fatTarget: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${fatTarget}g`,
                fiberTarget: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${fiberTarget}g`,
                sugarTarget: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${sugarTarget}g`
            };

            // Update progress bars
            const progress = {
                proteinProgress: Math.min((totalProtein / proteinTarget) * 100, 100),
                sodiumProgress: Math.min((totalSodium / sodiumTarget) * 100, 100),
                carbsProgress: Math.min((totalCarbs / carbsTarget) * 100, 100),
                fatProgress: Math.min((totalFat / fatTarget) * 100, 100),
                fiberProgress: Math.min((totalFiber / fiberTarget) * 100, 100),
                sugarProgress: Math.min((totalSugar / sugarTarget) * 100, 100)
            };

            // Apply updates to DOM
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            Object.entries(targets).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            Object.entries(progress).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.style.width = value + '%';
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress bar ‡∏´‡∏•‡∏±‡∏Å
            const mainProgress = Math.min((totalCalories / targetCalories) * 100, 100);
            const calorieProgressEl = document.getElementById('calorieProgress');
            if (calorieProgressEl) calorieProgressEl.style.width = mainProgress + '%';

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress ring
            const progressRingEl = document.getElementById('progressRing');
            const progressTextEl = document.getElementById('progressText');
    
            if (progressRingEl && progressTextEl) {
                const circumference = 2 * Math.PI * 50; // radius = 50
                const offset = circumference - (mainProgress / 100) * circumference;
                progressRingEl.style.strokeDashoffset = offset;
                progressTextEl.textContent = Math.round(mainProgress) + '%';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        function loadHistory() {
            const historyContainer = document.getElementById('historyList');
            if (!historyContainer) return;
            
            const userKey = window.currentUser || 'demo';
            const userLog = window.dailyFoodLog[userKey] || {};
            
            if (!userLog || Object.keys(userLog).length === 0) {
                historyContainer.innerHTML = '<p style="color: #666; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>';
                return;
            }

            const sortedDates = Object.keys(userLog)
                .sort((a, b) => new Date(b) - new Date(a))
                .slice(0, 10); // Show last 10 days

            historyContainer.innerHTML = sortedDates.map(date => {
                const dayLog = userLog[date];
                let totalCalories = 0;
                
                Object.values(dayLog).forEach(meal => {
                    if (Array.isArray(meal)) {
                        meal.forEach(food => {
                            totalCalories += food.calories || 0;
                        });
                    }
                });

                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                return `
                    <div class="food-item" style="margin-bottom: 15px;">
                        <div class="food-info">
                            <div class="food-name">${formattedDate}</div>
                            <div class="food-details">‡∏£‡∏ß‡∏° ${Math.round(totalCalories)} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
                        </div>
                        <div>${Math.round(totalCalories)} kcal</div>
                    </div>
                `;
            }).join('');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î TDEE
        function calculateTDEE(profile) {
            const { age, gender, height, weight, activity } = profile;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î BMR ‡∏î‡πâ‡∏ß‡∏¢ Mifflin-St Jeor equation
            let bmr;
            if (gender === 'male') {
                bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î TDEE
            const tdee = bmr * parseFloat(activity);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î BMI
            const bmi = weight / ((height / 100) ** 2);
            
            return { bmr: Math.round(bmr), tdee: Math.round(tdee), bmi: bmi.toFixed(1) };
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        function updateProfile() {
            const userKey = window.currentUser || 'demo';
            
            if (!window.userData) window.userData = {};
            if (!window.userData[userKey]) {
                window.userData[userKey] = { 
                    name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                    profile: getDefaultProfile() 
                };
            }

            const profile = window.userData[userKey].profile;
            
            const ageEl = document.getElementById('age');
            const genderEl = document.getElementById('gender');
            const heightEl = document.getElementById('height');
            const weightEl = document.getElementById('weight');
            const activityEl = document.getElementById('activity');
            const goalEl = document.getElementById('goal');
            const targetWeightEl = document.getElementById('targetWeight');
            
            if (ageEl && ageEl.value) profile.age = parseInt(ageEl.value);
            if (genderEl) profile.gender = genderEl.value;
            if (heightEl && heightEl.value) profile.height = parseInt(heightEl.value);
            if (weightEl && weightEl.value) profile.weight = parseFloat(weightEl.value);
            if (activityEl) profile.activity = parseFloat(activityEl.value);
            if (goalEl) profile.goal = parseFloat(goalEl.value);
            if (targetWeightEl && targetWeightEl.value) profile.targetWeight = parseFloat(targetWeightEl.value);

            // Only calculate if we have minimum required data
            if (profile.age && profile.height && profile.weight) {
                const results = calculateTDEE(profile);
                const goalCalories = results.tdee + (profile.goal * 7700 / 7); // 7700 kcal = 1 kg

                // Update display elements
                const bmrValueEl = document.getElementById('bmrValue');
                const tdeeValueEl = document.getElementById('tdeeValue');
                const targetCaloriesEl = document.getElementById('targetCalories');
                const bmiValueEl = document.getElementById('bmiValue');
                const tdeeResultEl = document.getElementById('tdeeResult');

                if (bmrValueEl) bmrValueEl.textContent = results.bmr;
                if (tdeeValueEl) tdeeValueEl.textContent = results.tdee;
                if (targetCaloriesEl) targetCaloriesEl.textContent = Math.round(goalCalories);
                if (bmiValueEl) bmiValueEl.textContent = results.bmi;
                if (tdeeResultEl) tdeeResultEl.style.display = 'block';

                profile.targetCalories = Math.round(goalCalories);
            }
            
            // Save and update
            if (window.saveToStorage) window.saveToStorage();
            if (window.syncToFirestore) window.syncToFirestore();
            
            updateDailyStats();
            updateAllCharts();
            
            alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        function loadProfile() {
            const userKey = window.currentUser || 'demo';
            
            // Ensure user data exists
            if (!window.userData) window.userData = {};
            if (!window.userData[userKey]) {
                window.userData[userKey] = { 
                    name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                    profile: getDefaultProfile() 
                };
            }
            
            const profile = window.userData[userKey].profile;
            
            const ageEl = document.getElementById('age');
            const genderEl = document.getElementById('gender');
            const heightEl = document.getElementById('height');
            const weightEl = document.getElementById('weight');
            const activityEl = document.getElementById('activity');
            const goalEl = document.getElementById('goal');
            const targetWeightEl = document.getElementById('targetWeight');

            if (ageEl) ageEl.value = profile.age || '';
            if (genderEl) genderEl.value = profile.gender || 'male';
            if (heightEl) heightEl.value = profile.height || '';
            if (weightEl) weightEl.value = profile.weight || '';
            if (activityEl) activityEl.value = profile.activity || 1.375;
            if (goalEl) goalEl.value = profile.goal || 0;
            if (targetWeightEl) targetWeightEl.value = profile.targetWeight || '';

            // Auto-calculate if data exists
            if (profile.age && profile.height && profile.weight && !profile.targetCalories) {
                updateProfile();
            }
        }

        function getDefaultProfile() {
            return {
                age: 25,
                gender: 'male',
                height: 170,
                weight: 70,
                activity: 1.375,
                goal: 0,
                targetWeight: 70,
                targetCalories: 2000
            };
        }

        // UI Functions
        function showTab(tabName) {
            // ‡∏ã‡πà‡∏≠‡∏ô tab ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // ‡πÅ‡∏™‡∏î‡∏á tab ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) targetTab.classList.add('active');
            
            if (event && event.target) event.target.classList.add('active');

            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'analytics') {
                updateAllCharts();
            }
        }

        function showProfile() {
            showTab('profile');
        }

        function quickAddFood() {
            showTab('food');
            const foodNameEl = document.getElementById('foodName');
            if (foodNameEl) foodNameEl.focus();
        }

        function hideStorageWarning() {
            document.getElementById('storageWarning').style.display = 'none';
        }

        // Make functions global for onclick handlers
        window.addFood = addFood;
        window.removeFood = removeFood;
        window.updateProfile = updateProfile;
        window.loadProfile = loadProfile;
        window.showTab = showTab;
        window.showProfile = showProfile;
        window.quickAddFood = quickAddFood;
        window.addWeightEntry = addWeightEntry;
        window.changeCaloriePeriod = changeCaloriePeriod;
        window.openBarcodeScanner = openBarcodeScanner;
        window.closeBarcodeScanner = closeBarcodeScanner;
        window.selectSuggestionByClick = selectSuggestionByClick;
        window.updateDailyStats = updateDailyStats;
        window.loadFoodLog = loadFoodLog;
        window.updateAllCharts = updateAllCharts;
        window.hideStorageWarning = hideStorageWarning;

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const loginEmailEl = document.getElementById('loginEmail');
            const loginPasswordEl = document.getElementById('loginPassword');
            const regPasswordEl = document.getElementById('regPassword');
            const forgotEmailEl = document.getElementById('forgotEmail');
            const otpCodeEl = document.getElementById('otpCode');
            const newPasswordEl = document.getElementById('newPassword');
            const confirmPasswordEl = document.getElementById('confirmPassword');
            
            // Login form events
            if (loginEmailEl) {
                loginEmailEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && window.login) window.login();
                });
            }
            
            if (loginPasswordEl) {
                loginPasswordEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && window.login) window.login();
                });
            }
            
            // Register form events
            if (regPasswordEl) {
                regPasswordEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && window.register) window.register();
                });
            }
            
            // Forgot password form events
            if (forgotEmailEl) {
                forgotEmailEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && window.sendOTP) window.sendOTP();
                });
            }
            
            // OTP form events
            if (otpCodeEl) {
                // Auto-format OTP input
                otpCodeEl.addEventListener('input', function(e) {
                    // Only allow numbers
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    // Auto-focus next field when 6 digits are entered
                    if (e.target.value.length === 6) {
                        const newPasswordEl = document.getElementById('newPassword');
                        if (newPasswordEl) newPasswordEl.focus();
                    }
                });
                
                otpCodeEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const newPasswordEl = document.getElementById('newPassword');
                        if (newPasswordEl) newPasswordEl.focus();
                    }
                });
            }
            
            if (newPasswordEl) {
                newPasswordEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const confirmPasswordEl = document.getElementById('confirmPassword');
                        if (confirmPasswordEl) confirmPasswordEl.focus();
                    }
                });
            }
            
            if (confirmPasswordEl) {
                confirmPasswordEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && window.resetPassword) window.resetPassword();
                });
            }

            // Food form events
            const foodNameEl = document.getElementById('foodName');
            if (foodNameEl) {
                foodNameEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && selectedSuggestionIndex === -1) {
                        addFood();
                    }
                });
            }

            const foodAmountEl = document.getElementById('foodAmount');
            if (foodAmountEl) {
                foodAmountEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') addFood();
                });
            }

            const manualCaloriesEl = document.getElementById('manualCalories');
            if (manualCaloriesEl) {
                manualCaloriesEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') addFood();
                });
            }

            // Profile form auto-save on change
            const profileInputs = ['age', 'gender', 'height', 'weight', 'activity', 'goal', 'targetWeight'];
            profileInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', function() {
                        // Auto-save after 2 seconds of no changes
                        clearTimeout(window.profileSaveTimeout);
                        window.profileSaveTimeout = setTimeout(() => {
                            if (window.saveToStorage) window.saveToStorage();
                        }, 2000);
                    });
                }
            });
        });

        // Periodic data backup
        setInterval(() => {
            if (window.currentUser) {
                // Create backup in different key
                try {
                    const backupData = {
                        users: window.userData || {},
                        dailyLog: window.dailyFoodLog || {},
                        weightLog: window.weightLog || {},
                        currentUser: window.currentUser,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('calorieAppBackup', JSON.stringify(backupData));
                } catch (e) {
                    console.error('Cannot create backup:', e);
                }
            }
        }, 300000); // Every 5 minutes

        // Recovery function for corrupted data
        function recoverFromBackup() {
            try {
                const backup = localStorage.getItem('calorieAppBackup');
                if (backup) {
                    const backupData = JSON.parse(backup);
                    window.userData = backupData.users || {};
                    window.dailyFoodLog = backupData.dailyLog || {};
                    window.weightLog = backupData.weightLog || {};
                    console.log('Data recovered from backup');
                    return true;
                }
            } catch (e) {
                console.error('Cannot recover from backup:', e);
            }
            return false;
        }

        // Export data function
        function exportData() {
            try {
                const exportData = {
                    users: window.userData || {},
                    dailyLog: window.dailyFoodLog || {},
                    weightLog: window.weightLog || {},
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `caloriepal-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (e) {
                console.error('Export failed:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // Import data function
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users) {
                        // Merge with existing data
                        window.userData = { ...window.userData, ...importedData.users };
                    }
                    if (importedData.dailyLog) {
                        window.dailyFoodLog = { ...window.dailyFoodLog, ...importedData.dailyLog };
                    }
                    if (importedData.weightLog) {
                        window.weightLog = { ...window.weightLog, ...importedData.weightLog };
                    }
                    
                    // Save merged data
                    if (window.saveToStorage) window.saveToStorage();
                    if (window.syncToFirestore) window.syncToFirestore();
                    
                    // Refresh displays
                    if (window.currentUser) {
                        loadProfile();
                        updateDailyStats();
                        loadFoodLog();
                        updateAllCharts();
                    }
                    
                    alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } catch (error) {
                    console.error('Import failed:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢');
                }
            };
            reader.readAsText(file);
        }

        // Data management functions
        window.exportData = exportData;
        window.importData = importData;
        window.recoverFromBackup = recoverFromBackup;

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ
        init();
    </script>
</body>
</html>
